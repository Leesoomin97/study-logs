# Instance Segmentation: Mask R-CNN 기술 분석

## 1. 머리말

이전 글에서는 Segmentation을 **픽셀 단위 Dense Prediction 문제**로 정의하고, Semantic / Instance / Panoptic Segmentation의 차이를 기술적으로 비교했다.

그중 **Instance Segmentation**은 동일 클래스 내 여러 객체를 서로 독립된 인스턴스로 분리해야 하므로, Detection(객체 위치)과 Segmentation(객체 형태)을 함께 수행하는 모델이 필요하다.

이를 해결하기 위해 제안된 대표 모델이 **Mask R-CNN(2017)** 이다.  

Mask R-CNN은 Faster R-CNN의 Two-Stage Detection 구조를 확장하여  Bounding Box·클래스·픽셀 단위 마스크를 통합적으로 예측한다.

이번 글에서는 Mask R-CNN의 전체 구조와 구성요소를 기술적으로 분석한다.

---

## 2. Mask R-CNN 전체 구조

Mask R-CNN은 다음 단계들로 이루어진 Two-Stage Instance Segmentation 모델이다.

1. 먼저, **Backbone + FPN**으로 다중 스케일 Feature Map 생성하고  
2. **RPN**이 객체 후보 영역(Region Proposal)을 생성하며  
3. **ROI Align**으로 Proposal 영역을 정규화하고  
4. **Classification / BBox Regression / Mask Head**에서 병렬 예측한다.  
5. 최종적으로 객체별 **Class + Bounding Box + Pixel Mask** 이 출력된다. 

### 전체 구조도

```
입력 이미지
   ↓
Backbone (ResNet + FPN)
   ↓
RPN (Region Proposal Network)
   ↓
ROI Align
   ↓
 ┌──────────────────────────────────────────┐
 │         Multi-task Prediction Heads      │
 │    ├─ Classification Head                │
 │    ├─ Bounding Box Regression Head       │
 │    └─ Mask Head                          │
 └──────────────────────────────────────────┘
```

---

# 3. 주요 구성요소 


## (1) Backbone + FPN

● **역할**  
- 이미지에서 다양한 수준의 Feature Map 추출
- 또한 작은 객체부터 큰 객체까지 대응할 수 있는 다중 스케일 Feature을 제공  

● **기술적 특징**  
- ResNet-50/101 기반 계층적 Feature Extractor  
- FPN(Feature Pyramid Network)으로 저해상도·고해상도 Feature 결합  
- Top-down + lateral connection 구조  
- Detection과 Segmentation에 안정적인 Feature 표현 제공  

---

## (2) RPN (Region Proposal Network)

● **역할**  
- Feature Map 위에서 객체가 있을 가능성이 높은 후보 영역 생성  
- 전체 파이프라인에서 “분석할 위치(Region)” 선택  

● **기술적 특징**  
- Anchor 기반 Objectness Score + BBox Offset 회귀  
- Sliding convolution으로 Feature Map 전체 스캔  
- NMS로 중복 Proposal 제거  
- 상위 N개의 Proposal만 ROI Align 단계로 전달  

---

## (3) ROI Align

● **역할**  
- 다양한 크기·비율의 Proposal을 고정 크기의 ROI Feature로 변환  
- Head 모듈이 일관된 크기의 입력을 처리할 수 있도록 정규화  

● **기술적 특징**  
- Bilinear Interpolation 기반의 연속 좌표 샘플링  
- ROI Pooling의 Quantization 문제 제거  
- 경계(Contour) 정보 보존 → Mask 예측 품질 향상  
- Mask R-CNN의 핵심 개선 요소  

---

## (4) Multi-task Prediction Heads  
ROI Align 결과는 Detection과 Segmentation의 병렬 수행을 위해 세 개의 Head로 나누어 처리된다.


### 1) Classification Head  
● **역할**  
- 각 ROI의 클래스 예측  

● **기술적 특징**  
- Fully Connected Layer 기반  
- Softmax 다중 클래스 분류  
- Cross Entropy Loss 사용  

---

### 2) Bounding Box Regression Head  
● **역할**  
- Proposal 좌표를 실제 객체 위치에 맞게 보정  

● **기술적 특징**  
- Bounding Box Offset 회귀  
- Smooth L1 Loss 사용  
- Classification Head와 병렬로 학습됨  

---

### 3) Mask Head  
● **역할**  
- 각 ROI에 대해 28×28 해상도의 픽셀 단위 마스크 생성  

● **기술적 특징**  
- 소형 Convolution Branch 기반  
- 클래스별 독립적인 Mask 채널(class-specific mask)  
- Pixel-wise Binary Cross Entropy Loss  
- Classification 결과와 독립적으로 객체 형태 복원  

---

# 4. 최종 출력 (Output Summary)

Mask R-CNN은 아래 세 가지 결과를 동시에 제공한다.

---

## (1) Class Prediction  
- Classification Head가 산출한 클래스 라벨  
- Confidence Score 포함  
- Score Threshold 및 NMS 적용  

---

## (2) Bounding Box  
- Regression Head가 보정한 최종 위치 정보  
- (x, y, w, h) 또는 (x1, y1, x2, y2) 포맷  
- NMS 또는 Soft-NMS로 중복 제거  

---

## (3) Pixel-level Mask  
- Mask Head가 예측한 28×28 마스크를 BBox 크기에 맞게 업샘플링  
- 동일 클래스 내 여러 객체도 독립적으로 분할  
- Instance Segmentation을 완성하는 핵심 출력  

---

# 5. 마무리

Mask R-CNN은 Instance Segmentation의 표준 모델로, Detection과 Segmentation을 동시에 해결하는 구조를 갖추고 있다.

핵심 기술적 기여는 다음과 같다.

- **ROI Align**으로 경계 손실 문제 해결  
- **Multi-task 구조**로 Detection·Segmentation 동시 최적화  
- **FPN 기반 Backbone**으로 다양한 객체 크기에 대응  

후속 모델(SOLO, YOLACT, CondInst 등)은 Mask R-CNN의 구조를 기반으로 실시간 처리와 경량화를 목표로 발전하고 있다.

---
